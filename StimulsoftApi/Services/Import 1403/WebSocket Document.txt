Û±. ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ WebSocket Ø¯Ø± ASP.NET Core

Ø¯Ø± Program.cs:


var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseWebSockets();   // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ WebSocket

app.Map("/ws", async (HttpContext context) =>
{
    if (context.WebSockets.IsWebSocketRequest)
    {
        var webSocket = await context.WebSockets.AcceptWebSocketAsync();
        await HandleWebSocketConnection(context, webSocket);
    }
    else
    {
        context.Response.StatusCode = StatusCodes.Status400BadRequest;
    }
});

app.Run();


--------------------------------------------------------------------------

Û². Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„ WebSocket (Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…)


Ù…ØªØ¯ÛŒ Ú©Ù‡ WebSocket Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯:


private async Task HandleWebSocketConnection(HttpContext context, WebSocket webSocket)
{
    var buffer = new byte[1024 * 4];

    while (webSocket.State == WebSocketState.Open)
    {
        var result = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);

        if (result.MessageType == WebSocketMessageType.Close)
        {
            await webSocket.CloseAsync(WebSocketCloseStatus.NormalClosure, "Closed", CancellationToken.None);
            break;
        }
        else
        {
            var message = Encoding.UTF8.GetString(buffer, 0, result.Count);

            var response = Encoding.UTF8.GetBytes($"Server: {message}");

            await webSocket.SendAsync(
                new ArraySegment<byte>(response),
                WebSocketMessageType.Text,
                true,
                CancellationToken.None
            );
        }
    }
}


-------------------------------------------------------------------------------------

ğŸŸ© Û³. Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ù‡Ù… WebSocket Ø¯Ø± ASP.NET Core

âœ” Û±. AcceptWebSocketAsync()  Ø¯Ø±Ø®ÙˆØ§Ø³Øª WebSocket Ø±Ø§ Ù‚Ø¨ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯

var ws = await context.WebSockets.AcceptWebSocketAsync();


Û². ReceiveAsync()

Ù¾ÛŒØ§Ù…â€Œ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯:

var result = await ws.ReceiveAsync(buffer, CancellationToken.None);


âœ” Û³. SendAsync()


Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:

await ws.SendAsync(
    new ArraySegment<byte>(data),
    WebSocketMessageType.Text,
    true,
    CancellationToken.None
);




Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§:

Ù¾Ø§Ø±Ø§Ù…ØªØ±	ØªÙˆØ¶ÛŒØ­
Ø¯Ø§Ø¯Ù‡	Ø¨Ø§ÛŒØªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆÙ†Ø¯
Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…	Text ÛŒØ§ Binary
EndOfMessage	Ø¢ÛŒØ§ Ù¾ÛŒØ§Ù… Ø¢Ø®Ø± Ù‚Ø·Ø¹Ù‡ Ø§Ø³ØªØŸ
CancellationToken	Ú©Ù†ØªØ±Ù„ Ù„ØºÙˆ




âœ” Û´. CloseAsync()

Ø¨Ø³ØªÙ† Ø§ØªØµØ§Ù„ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯


await ws.CloseAsync(
    WebSocketCloseStatus.NormalClosure,
    "Closing",
    CancellationToken.None
);


Ûµ. ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„

ws.State



Ù…Ù‚Ø¯Ø§Ø±Ù‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯:

Open

Closed

Aborted

CloseSent

CloseReceived




ğŸŸ§ Û´. Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Connection Ù‡Ø§ Ù…Ø§Ù†Ù†Ø¯ SignalR


public static ConcurrentDictionary<string, WebSocket> Sockets =
    new ConcurrentDictionary<string, WebSocket>();


Ù‡Ù†Ú¯Ø§Ù… Ø§ØªØµØ§Ù„


var id = Guid.NewGuid().ToString();
Sockets.TryAdd(id, webSocket);


Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡:

foreach (var socket in Sockets.Values)
{
    await socket.SendAsync(buffer, WebSocketMessageType.Text, true, CancellationToken.None);
}



ğŸŸ§ Ûµ. Ú©Ù„Ø§ÛŒÙ†Øª Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ WebSocket Ø®Ø§Ù…

const ws = new WebSocket("wss://localhost:5001/ws");

ws.onopen = () => {
    ws.send("Hello server!");
};

ws.onmessage = (msg) => {
    console.log("Server says: ", msg.data);
};



*******************************************************************************************************
Ø¯Ø± ØµÙˆØ±ØªÛŒÚ©Ù‡ Ø¨Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¨Ø§ Ø¯Ùˆ ØªØ§ Ù¾Ø±ÙˆÚ˜Ù‡ Ù†ÙˆØ¹ 
asp core websocket
Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…

-------------------
Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ÙˆÙ„ Ø³Ù…Øª Ø³Ø±ÙˆØ±
ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ WebSocket




var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseWebSockets();

app.Map("/ws", async (HttpContext context) =>
{
    if (context.WebSockets.IsWebSocketRequest)
    {
        var webSocket = await context.WebSockets.AcceptWebSocketAsync();
        await HandleServerSocket(context, webSocket);
    }
    else
    {
        context.Response.StatusCode = 400;
    }
});

app.Run();

-------------------------------
Ù…Ø¯ÛŒØ±ÛŒØª WebSocket Server


public static async Task HandleServerSocket(HttpContext context, WebSocket socket)
{
    var buffer = new byte[1024 * 4];

    while (socket.State == WebSocketState.Open)
    {
        var res = await socket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);

        if (res.MessageType == WebSocketMessageType.Close)
        {
            await socket.CloseAsync(WebSocketCloseStatus.NormalClosure, "Closed", CancellationToken.None);
            break;
        }
        else
        {
            var msg = Encoding.UTF8.GetString(buffer, 0, res.Count);
            Console.WriteLine($"Message from Client: {msg}");

            // Ù¾Ø§Ø³Ø®
            var serverMsg = Encoding.UTF8.GetBytes($"Server received: {msg}");
            await socket.SendAsync(serverMsg, WebSocketMessageType.Text, true, CancellationToken.None);
        }
    }
}

------------------------------------------------------Ø¨Ø®Ø´ Ø¯ÙˆÙ…
Ø³Ù…Øª Ú©Ù„Ø§ÛŒÙ†Øª

Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯Ø´ ÛŒÚ© WebSocket Client Ø§Ø³Øª Ú©Ù‡ Ø¨Ù‡ API A ÙˆØµÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.


using System.Net.WebSockets;

public class WebSocketClientService
{
    private ClientWebSocket _client;

    public async Task ConnectAsync()
    {
        _client = new ClientWebSocket();
        await _client.ConnectAsync(new Uri("ws://localhost:5000/ws"), CancellationToken.None);
        Console.WriteLine("Connected to WebSocket Server");

        _ = ReceiveMessages();  // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¯Ø§Ø¦Ù…ÛŒ
    }

    public async Task SendAsync(string message)
    {
        var bytes = Encoding.UTF8.GetBytes(message);
        await _client.SendAsync(bytes, WebSocketMessageType.Text, true, CancellationToken.None);
    }

    private async Task ReceiveMessages()
    {
        var buffer = new byte[1024 * 4];
        while (_client.State == WebSocketState.Open)
        {
            var result = await _client.ReceiveAsync(buffer, CancellationToken.None);
            var msg = Encoding.UTF8.GetString(buffer, 0, result.Count);
            Console.WriteLine("Server says: " + msg);
        }
    }
}




builder.Services.AddSingleton<WebSocketClientService>();
var app = builder.Build();

var wsClient = app.Services.GetRequiredService<WebSocketClientService>();
await wsClient.ConnectAsync();



3ï¸âƒ£ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±ÛŒÙ‚ Controller

[ApiController]
[Route("api/send")]
public class SendController : ControllerBase
{
    private readonly WebSocketClientService _ws;

    public SendController(WebSocketClientService ws)
    {
        _ws = ws;
    }

    [HttpPost]
    public async Task<IActionResult> SendMessage([FromBody] string msg)
    {
        await _ws.SendAsync(msg);
        return Ok("Sent");
    }
}

-----------------------------------------------------------------------------------------------











