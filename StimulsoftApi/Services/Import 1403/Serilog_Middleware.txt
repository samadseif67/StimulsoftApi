// Ø¯Ø± Program.cs ÛŒØ§ ÛŒÚ© Middleware Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
app.UseSerilogRequestLogging(); // Ø§Ú¯Ø± Ø§Ø² Serilog.AspNetCore Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ â€” Ø®ÛŒÙ„ÛŒ Ø³Ø§Ø¯Ù‡!



app.Use(async (context, next) =>
{
    var sw = Stopwatch.StartNew();
    _logger.LogInformation("Started request {Method} {Url}", context.Request.Method, context.Request.Path);

    await next();

    sw.Stop();
    _logger.LogInformation("Finished request {Method} {Url} in {ElapsedMs}ms with status {StatusCode}",
        context.Request.Method,
        context.Request.Path,
        sw.ElapsedMilliseconds,
        context.Response.StatusCode);
});


//*********************************************************************************************************
Ù‡Ù…Ù‡ ExceptionÙ‡Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¨Ø§ÛŒØ¯ Ù„Ø§Ú¯ Ø´ÙˆÙ†Ø¯

-------
Ø±ÙˆØ´ Ø§ÙˆÙ„


var builder = WebApplication.CreateBuilder(args);

// ØªÙ†Ø¸ÛŒÙ… Serilog
builder.Host.UseSerilog((ctx, lc) => lc
    .ReadFrom.Configuration(ctx.Configuration)
    .WriteTo.Console()
    .WriteTo.Seq("http://localhost:5341") // ÛŒØ§ Elasticsearch
);

var app = builder.Build();

// Middleware Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
app.UseExceptionHandler(errorApp =>
{
    errorApp.Run(async context =>
    {
        context.Response.StatusCode = 500;
        context.Response.ContentType = "application/json";

        var exceptionHandlerPathFeature = 
            context.Features.Get<IExceptionHandlerPathFeature>();

        var exception = exceptionHandlerPathFeature?.Error;

        // ğŸ”¥ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Exception Ø¨Ø§ Serilog
        Log.Fatal(exception, "Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª: {Path}", context.Request.Path);

        // Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® JSON Ø¨Ù‡ Ú©Ù„Ø§ÛŒÙ†Øª
        await context.Response.WriteAsync(new
        {
            StatusCode = 500,
            Message = "Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.",
            // Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¬Ø²Ø¦ÛŒØ§Øª Exception Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯:
            // Detail = exception?.ToString()
        }.ToString());
    });
});

// ÙÙ‚Ø· Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}

app.UseRouting();
app.MapControllers(); // ÛŒØ§ MapGet Ùˆ ...

app.Run();






-------
Ø±ÙˆØ´ Ø¯ÙˆÙ…
// Controllers/ErrorController.cs

[ApiController]
[ApiExplorerSettings(IgnoreApi = true)] // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§Ø² Swagger
public class ErrorController : ControllerBase
{
    [Route("/error")]
    public IActionResult Error()
    {
        var exceptionHandlerPathFeature = 
            HttpContext.Features.Get<IExceptionHandlerPathFeature>();

        var exception = exceptionHandlerPathFeature?.Error;

        // ğŸ”¥ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Exception
        Serilog.Log.Fatal(exception, "Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ù…Ø³ÛŒØ±: {Path}", exceptionHandlerPathFeature?.Path);

        return Problem(
            title: "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±",
            detail: "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª.",
            statusCode: 500
        );
    }
}

app.UseExceptionHandler("/error"); // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ Ú©Ù†ØªØ±Ù„Ø± Ø®Ø·Ø§

---------
Ø±ÙˆØ´ Ø³ÙˆÙ…


// Middleware/GlobalExceptionHandlerMiddleware.cs

public class GlobalExceptionHandlerMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<GlobalExceptionHandlerMiddleware> _logger;

    public GlobalExceptionHandlerMiddleware(RequestDelegate next, ILogger<GlobalExceptionHandlerMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª: {Path}", context.Request.Path);

            context.Response.StatusCode = 500;
            context.Response.ContentType = "application/problem+json";

            var problem = new ProblemDetails
            {
                Status = 500,
                Title = "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±",
                Detail = "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª.",
                Instance = context.Request.Path
            };

            await context.Response.WriteAsJsonAsync(problem);
        }
    }
}

// Extension Method Ø¨Ø±Ø§ÛŒ Ø±Ø§Ø­ØªÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡
public static class MiddlewareExtensions
{
    public static IApplicationBuilder UseGlobalExceptionHandler(this IApplicationBuilder app)
    {
        return app.UseMiddleware<GlobalExceptionHandlerMiddleware>();
    }
}

app.UseGlobalExceptionHandler(); // Ø¨Ù‡ Ø¬Ø§ÛŒ UseExceptionHandler

//********************************************************************************************************
Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²

// Ø¯Ø± Program.cs â€” Ø¨Ø¹Ø¯ Ø§Ø² UseRouting Ùˆ Ù‚Ø¨Ù„ Ø§Ø² UseEndpoints
app.Use(async (context, next) =>
{
    await next();

    if (context.Response.StatusCode == 401 || context.Response.StatusCode == 403)
    {
        var logger = context.RequestServices.GetRequiredService<ILogger<Program>>();

        var userId = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "Anonymous";
        var userName = context.User.Identity?.Name ?? "Unknown";
        var userAgent = context.Request.Headers["User-Agent"].ToString();
        var ip = context.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        if (context.Response.StatusCode == 401)
        {
            logger.LogWarning(
                "Unauthorized access attempt by user: {UserName} (ID: {UserId}) from IP: {IpAddress} to URL: {Url}. User-Agent: {UserAgent}",
                userName, userId, ip, context.Request.Path, userAgent);
        }
        else if (context.Response.StatusCode == 403)
        {
            logger.LogWarning(
                "Forbidden access attempt â€” user: {UserName} (ID: {UserId}) lacks required permissions for URL: {Url} from IP: {IpAddress}. User-Agent: {UserAgent}",
                userName, userId, ip, context.Request.Path, userAgent);
        }
    }
});

//*************************************************************************************************************
Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ø¯

public class UserEnricher : ILogEventEnricher
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public UserEnricher(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public void Enrich(LogEvent logEvent, ILogEventPropertyFactory propertyFactory)
    {
        var context = _httpContextAccessor.HttpContext;
        if (context?.User != null)
        {
            var userId = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                logEvent.AddPropertyIfAbsent(propertyFactory.CreateProperty("UserId", userId));
            }
        }
    }
}

builder.Host.UseSerilog((ctx, lc) => lc
    .Enrich.With<UserEnricher>()
    ...
);

//************************************************************************************************************

Ù†Ø­ÙˆÙ‡ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Serilog

Log.Logger = new LoggerConfiguration()
    .WriteTo.MSSqlServer(
        connectionString: "Server=.;Database=MyApp;Trusted_Connection=true;",
        sinkOptions: new MSSqlServerSinkOptions { TableName = "Logs", AutoCreateSqlTable = true },
        columnOptions: new ColumnOptions()
        {
            AdditionalColumns = new List<SqlColumn>
            {
                new SqlColumn("UserId", SqlDbType.NVarChar, 128),
                new SqlColumn("IpAddress", SqlDbType.NVarChar, 64),
                new SqlColumn("Url", SqlDbType.NVarChar, 512)
            }
        })
    .CreateLogger();



public class SqlLogEnricher : ILogEventEnricher
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public SqlLogEnricher(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public void Enrich(LogEvent logEvent, ILogEventPropertyFactory propertyFactory)
    {
        var context = _httpContextAccessor.HttpContext;
        if (context == null) return;

        // UserId
        var userId = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId))
            logEvent.AddOrUpdateProperty(propertyFactory.CreateProperty("UserId", userId));

        // IpAddress
        var ip = context.Connection.RemoteIpAddress?.ToString();
        if (!string.IsNullOrEmpty(ip))
            logEvent.AddOrUpdateProperty(propertyFactory.CreateProperty("IpAddress", ip));

        // Url
        var url = context.Request.Path.ToString();
        if (!string.IsNullOrEmpty(url))
            logEvent.AddOrUpdateProperty(propertyFactory.CreateProperty("Url", url));
    }
}

builder.Host.UseSerilog((ctx, lc) => lc
    .Enrich.With<SqlLogEnricher>()
    .WriteTo.MSSqlServer(...)
);

//*****************************************************************************************************


Ø§Ø±ØªØ¨Ø§Ø· Serilog Ø¨Ø§ Elasticsearch


Install-Package Serilog.Sinks.Elasticsearch


using Serilog;

var builder = WebApplication.CreateBuilder(args);

// ØªÙ†Ø¸ÛŒÙ… Serilog Ø¨Ø§ Elasticsearch
Log.Logger = new LoggerConfiguration()
    .Enrich.FromLogContext()
    .Enrich.WithMachineName()
    .Enrich.WithEnvironmentUserName()
    .WriteTo.Console()
    .WriteTo.Elasticsearch(new ElasticsearchSinkOptions(new Uri("http://localhost:9200"))
    {
        AutoRegisterTemplate = true, // Ø§ÛŒØ¬Ø§Ø¯ Template Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Elasticsearch
        AutoRegisterTemplateVersion = AutoRegisterTemplateVersion.ESv7, // ÛŒØ§ ESv8
        IndexFormat = "myapp-logs-{0:yyyy.MM.dd}", // ÙØ±Ù…Øª Index â€” Ø±ÙˆØ²Ø§Ù†Ù‡
        MinimumLogEventLevel = LogEventLevel.Information,
        ModifyConnectionSettings = x => x.BasicAuthentication("elastic", "your-password") // Ø§Ú¯Ø± Auth Ø¯Ø§Ø±ÛŒØ¯
    })
    .CreateLogger();

builder.Host.UseSerilog(); // Ø§Ø¯ØºØ§Ù… Ø¨Ø§ Host

var app = builder.Build();


----------------

using Serilog;

var logger = new LoggerConfiguration()
    .WriteTo.Console()
    .WriteTo.Elasticsearch(new ElasticsearchSinkOptions(new Uri("http://localhost:9200"))
    {
        AutoRegisterTemplate = true,
        IndexFormat = "logs-{0:yyyy.MM.dd}",
        MinimumLogEventLevel = Serilog.Events.LogEventLevel.Information
    })
    .CreateLogger();

Log.Logger = logger;

// Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡
Log.Information("Ø§ÛŒÙ† ÛŒÚ© Ù„Ø§Ú¯ ØªØ³Øª Ø§Ø³Øª.");



----------

{
  "Serilog": {
    "Using": [ "Serilog.Sinks.Elasticsearch" ],
    "MinimumLevel": "Information",
    "WriteTo": [
      {
        "Name": "Elasticsearch",
        "Args": {
          "nodeUris": "http://localhost:9200",
          "indexFormat": "logs-{0:yyyy.MM.dd}",
          "autoRegisterTemplate": true
        }
      }
    ]
  }
}


builder.Host.UseSerilog((context, config) =>
    config.ReadFrom.Configuration(context.Configuration));

//********************************************************************************************



 Ø§ØªØµØ§Ù„ Serilog Ø¨Ù‡ Seq

dotnet add package Serilog.Sinks.Seq



using Serilog;

var logger = new LoggerConfiguration()
    .WriteTo.Console()
    .WriteTo.Seq("http://localhost:5341") // Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Seq
    .CreateLogger();

Log.Logger = logger;

Log.Information("Ø§ÛŒÙ† ÛŒÚ© Ù„Ø§Ú¯ ØªØ³Øª Ø¨Ø±Ø§ÛŒ Seq Ø§Ø³Øª.");



----

{
  "Serilog": {
    "Using": [ "Serilog.Sinks.Seq" ],
    "MinimumLevel": "Information",
    "WriteTo": [
      {
        "Name": "Seq",
        "Args": {
          "serverUrl": "http://localhost:5341",
          "apiKey": "your-api-key-if-any"
        }
      }
    ]
  }
}


builder.Host.UseSerilog((context, config) =>
    config.ReadFrom.Configuration(context.Configuration));



------
Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ØŒ Ø­ØªÙ…Ø§Ù‹ Buffering Ùˆ ÙÙˆÙ„â€ŒØ¨Ú© (fallback) Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± ØµÙˆØ±Øª Ù‚Ø·Ø¹ÛŒ Elasticsearch ÛŒØ§ SeqØŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³Øª Ù†Ø±ÙˆÙ†Ø¯.


.WriteTo.Seq("http://localhost:5341", 
    bufferBaseFilename: "./logs/seq-buffer")
.WriteTo.File("./logs/fallback-.txt", rollingInterval: RollingInterval.Day)


//*******************************************************************************************





