Understanding the Pipeline Structure:

The YAML pipeline consists of three main stages:

1-Build Stage — Compiles and publishes the .NET Core MVC application.
2-Deploy Stage — Deploys the application to IIS and updates the database.
3-Artifacts Stage — Uploads build and database artifacts for future reference.



Triggering the Pipeline


trigger:
- main    //The pipeline runs automatically on any push to the main branch.


Pool Configuration  



pool: 'Local PC'   //در این قسمت نام agentpool را وارد میکنیم 


------------------------------------------------------------------------------------------------------------------

trigger:
- main   #هر وقت روی برنچ مورد نظر پوش انجام این پاپ لاین اجرا شود

pool:
  name:'Test1'
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  siteName: 'MyWebsite'
  appPoolName: 'MyAppPool'
  physicalPath: 'C:\inetpub\wwwroot\MyWebsite'
  port: 8041
  artifactName: 'drop'


steps:

# 1) نصب SDK دات‌نت
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'   # نسخه دات‌نت پروژه شما

# 2) رستور پکیج‌ها
- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

# 3) بیلد پروژه
- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfiguration)'

# 4) انتشار (Publish)
- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'

# 5) ذخیره خروجی (Artifact)
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'drop'



 # ====================
# 6) انتشار روی IIS
# ====================
- task: PowerShellOnTargetMachines@3
  displayName: 'Create AppPool if not exists'
  inputs:
    Machines: '*'  # تمام سرورها در Deployment Group
    ScriptType: 'InlineScript'
    InlineScript: |
      $appPoolName = "$(appPoolName)"
      if (-not (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue)) {
          Write-Host "Creating AppPool $appPoolName"
          New-WebAppPool -Name $appPoolName
      }

- task: PowerShellOnTargetMachines@3
  displayName: 'Create IIS Site if not exists'
  inputs:
    Machines: '*'
    ScriptType: 'InlineScript'
    InlineScript: |
      $siteName = "$(siteName)"
      $appPoolName = "$(appPoolName)"
      $physicalPath = "$(physicalPath)"
      $port = $(port)

      if (!(Test-Path $physicalPath)) {
          New-Item -Path $physicalPath -ItemType Directory -Force
      }

      if (-not (Get-Website -Name $siteName -ErrorAction SilentlyContinue)) {
          Write-Host "Creating IIS site $siteName"
          New-Website -Name $siteName -Port $port -PhysicalPath $physicalPath -ApplicationPool $appPoolName
      }

- task: IISWebAppDeploymentOnMachineGroup@0
  displayName: 'Deploy Web App Artifact'
  inputs:
    WebSiteName: '$(siteName)'
    Package: '$(Pipeline.Workspace)/$(artifactName)/**/*.zip'
    TakeAppOfflineFlag: true
    RemoveAdditionalFilesFlag: true

- task: PowerShellOnTargetMachines@3
  displayName: 'Restart AppPool'
  inputs:
    Machines: '*'
    ScriptType: 'InlineScript'
    InlineScript: |
      $appPoolName = "$(appPoolName)"
      Restart-WebAppPool -Name $appPoolName

